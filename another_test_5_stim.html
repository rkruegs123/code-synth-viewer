<!DOCTYPE html>
<html lang="en">
<head>
    <title>fMRI Stimuli</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="http://code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css" />

    <link href="./style1.css" rel="stylesheet"/>
    <link href="./solarized.css" rel="stylesheet"/>
    <link href="./xq-light.css" rel="stylesheet"/>
    <link href="./xq-dark.css" rel="stylesheet"/>
    <link href="./blackboard.css" rel="stylesheet"/>
    <script type="text/javascript" src="stimuli_5_stim.json"></script>



<script type = "text/javascript">

    /* FIXME, create array of random ints from 2000 to 10000*/
    var plusDelay = 5000;
    var has_started = false;
    console.log("Setting to false")
    var record_keystrokes = false;
  window.onload = function () {

    var editableCodeMirror = CodeMirror.fromTextArea(document.getElementById('codesnippet_editable'), {
        lineNumbers: true,
        matchBrackets: true,
        mode: "text/plain",
        theme: "blackboard",
        lineWrapping: true
    });
    editableCodeMirror.setSize(null, $(window).height()-200);
    editableCodeMirror.setOption("theme", "blackboard");
    editableCodeMirror.setOption("mode", "text/plain");
};


$.fn.setCursorPosition = function(pos) {
    if ($(this).get(0).setSelectionRange) {
        $(this).get(0).setSelectionRange(pos, pos);
    } else if ($(this).get(0).createTextRange) {
        var range = $(this).get(0).createTextRange();
        range.collapse(true);
        range.moveEnd('character', pos);
        range.moveStart('character', pos);
        range.select();
    }
}

/**
 * Returns a random number between min (inclusive) and max (exclusive)
 */
function getRandomArbitrary(min, max) {
    return Math.random() * (max - min) + min;
}

/**
 * Returns a random integer between min (inclusive) and max (inclusive)
 * Using Math.round() will give you a non-uniform distribution!
 */
function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}



      // record all keystrokes + time
      $(document).ready(function() { 
        $(document).keydown(function(event) {
          console.log("detecting keystroke")
          if (!has_started) {
            console.log("has not started")
            /* event.keyCode = "=" 61 on Firefox, 187 on everything else?*/
            if (event.keyCode == 187) {
              console.log("equals sign detected")
              var the_url ="http://localhost:3000/start";
              $.ajax(
                { url: the_url, complete: function() {} }
              );
              has_started = true;
              // displayNextStimuli();
              startTimer();
            }
          } else {
            if (record_keystrokes) {
              console.log("recording keystroke")
              var my_url ="http://localhost:3000/keystroke?key="+event.which;
              $.ajax(
                { url: my_url, complete: function() {} }
              );
            }
          } 
        });
        // prepare plus focal relax thing
        $("#plus_img").width($(window).width());
        $("#plus_img").height($(window).height());
        $("#plus_img").show();
        // $("#plus_img").show().delay(plusDelay).queue(function(n) {$(this).hide(); n();});
//        $("#codesnippet_editable").delay(plusDelay).

		$('#codesnippet_editable').focus();
		$('#codesnippet_editable').setCursorPosition(10);
		
        $("#textarea_div").height($(window).height()-100);
        $("#codesnippet_editable").css("height", "100%");


      });



          const Categories = Object.freeze({
            ProseWritingA: 0,
            ProseWritingB: 1,
            CodeWritingX: 2,
            CodeWritingY:  3
          });


          var category = Categories.ProseWritingA;
          //var stimulus_time = 2000 + plusDelay; // includes an extra 5 s to show the focal plus
          var stimulus_time = 30000
          // stimulus_time = 30s + random[i]
          // total_time is 30s * num_stimuli + (sum(random))

          function changeCategory() {
            console.log("Changing category")
            var editor = $('.CodeMirror')[0].CodeMirror;
            category = (category + 1) % 4;
            console.log("Changing category...")
            // Set right Code Mirror
            console.log(category)
            if (category == Categories.ProseWritingA || category == Categories.ProseWritingB) {
              console.log("Setting to plain...")
              editor.setOption("mode", "text/plain");
            } else {
              console.log("Setting to c++...")
              editor.setOption("mode", "text/x-c++src");
            }
          }

          function displayNextStimuli() {
              console.log("Displaying next stimuli...")
              var editor = $('.CodeMirror')[0].CodeMirror;
              var cm = editor.getWrapperElement();
/*                <input class="CodeMirror"/> */
                
                plusDelay = getRandomInt(2, 10) * 1000
                console.log("Plus delay is", plusDelay)

                $(cm).readOnly = true;
                $(cm).hide();
                console.log("Setting to false")
                record_keystrokes = false;
                $("#plus_img").show().delay(plusDelay).queue(
                function(n) {
                    $(this).hide(); 
                    $(cm).readOnly = false;
                    $(cm).show();
                    editor.refresh();
                    console.log("Setting to true")
                    record_keystrokes = true;
                    n();
                });

                // Potentiallly delay before n()
                // Maybe split up delay with fixation 
                // $(document).delay(5 + plusDelay).queue( displayNextStimuli );
                
                $(document).delay(stimulus_time + plusDelay).queue(
                function(n) {
                  displayNextStimuli();
                  n();
                }
                );
             
              /* queue up the next call to displayNextStimuli based on
              newly-computed 30s + random[i+1] time*/ 

        //    $("#codesnippet_editable").delay(plusDelay).selectRange(3, 5);
              var text = editor.getValue();
              var prompt = document.getElementById('question').innerHTML;
              $('#codesnippet_editable').setCursorPosition(10);
              var query = "http://localhost:3000/nextstim?area=" + encodeURIComponent(text) + "&prompt="+encodeURIComponent(prompt);

              $.ajax({
                type: "GET",
                url: query,
                dataType: "json"
              }).done (function (data) {
                console.log(data);
                var stimulus;
                if (data.category == Categories.ProseWritingA) {
                  stimulus = stimuli[0][data.index];
                  console.log("category a");
                  editor.setOption("mode", "text/plain");
                } else if (data.category == Categories.ProseWritingB) {
                  stimulus = stimuli[1][data.index];
                  console.log("category b");
                  editor.setOption("mode", "text/plain");
                } else if (data.category == Categories.CodeWritingX) {
                  stimulus = stimuli[2][data.index];
                  console.log("category c");
                  editor.setOption("mode", "text/x-c++src");
                } else {
                  stimulus = stimuli[3][data.index];
                  console.log("category d");
                  editor.setOption("mode", "text/x-c++src");
                }
                console.log(stimulus);
                document.getElementById("question").innerHTML = stimulus.prompt;
                editor.setValue(stimulus.text);
                editor.refresh();
              });

              
          }

          function startTimer() {
              console.log("Starting timer...")
              //setInterval(changeCategory, stimulus_time * 21);

                /* rather than setInterval, use delay / queue to call
                displayNextStimuli */
              //setInterval(displayNextStimuli, stimulus_time);
              displayNextStimuli()

          }

          x = 0;
</script>
</head>
<body>
  <script>
    // startTimer();
  </script>
  <p id="question">Loading...</p>
  <link rel="stylesheet" href="http://codemirror.net/lib/codemirror.css">
  <script src="http://codemirror.net/lib/codemirror.js"></script>
  <script src="http://codemirror.net/addon/edit/matchbrackets.js"></script>
  <script src="http://codemirror.net/addon/edit/continuecomment.js"></script>
  <script src="http://codemirror.net/mode/javascript/javascript.js"></script>
  <script src="http://codemirror.net/mode/clike/clike.js"></script>  

<div>
    
<textarea rows="4" cols="50" name="codesnippet_editable" id="codesnippet_editable">
Please wait

</textarea>
<div id="rest_div" style="display: none;" align="center">
  <p style="color:red;font-size:256px;">+</p>
</div>

</div>
  <div id="plus_img"
  style="position:absolute;top:-50px;height:1200px;left:0px;z-index:1000;font-size:1024px;color:red;text-align:center;
  background-color:white;vertical-align:middle;">+
  
  </div>

</body>
</html>
