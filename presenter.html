<!DOCTYPE html>
<html lang="en">
<head>
    <title>CodeSynthViewer</title>
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>

    <link rel="stylesheet" href="css/jquery-ui.css" />
    <script src="js/seedrandom.min.js"></script>

    <link href="./solarized.css" rel="stylesheet"/>
    <link href="./blackboard.css" rel="stylesheet"/>
    <script type="text/javascript" src="stim_final.json"></script>

	<style type="text/css">
    #rest_div {
    	margin:auto;
    	width:100%;
    	height:100%;
    }
    #question {
    	font-size:36px;
    }
    .CodeMirror {
    	font-size:36px;
    }
	</style>

  <script type = "text/javascript">

    // Print the stimuli to consol
    console.log(stimuli)

    function add(a, b) {
        return a + b;
    }

    // Returns a random number between min (inclusive) and max (exclusive)
    function getRandomArbitrary(min, max) {
        return Math.random() * (max - min) + min;
    }

    function getRandsThatSumTo(num_rands, val) {
      var rands = [];
      var i;
      for (i = 0; i < num_rands; i++) {
        rands[i] = getRandomArbitrary(0.3, 0.9);
      }
      var sum = rands.reduce(add, 0);
      var to_return = [];
      for (i = 0; i < num_rands; i++) {
        to_return[i] = rands[i]/sum * val;
      }
      return to_return;
    }

    /* FIXME, create array of random ints from 2000 to 10000*/
    var plusDelay = 0;
    var has_started = false;
    var stopped = true;
    var record_keystrokes = false;
    console.log("Should be 21 vals that add to 90");
    var plus_delays = []
    var curr_index = -1

    window.onload = function () {

      var editableCodeMirror = CodeMirror.fromTextArea(document.getElementById('codesnippet_editable'), {
          lineNumbers: true,
          matchBrackets: true,
          autoCloseBrackets: true,
          mode: "text/plain",
          theme: "blackboard",
          lineWrapping: true,
          autofocus: true
      });
      editableCodeMirror.setSize(null, $(window).height()-200);
      editableCodeMirror.setOption("theme", "blackboard");
      editableCodeMirror.setOption("mode", "text/plain");


      $.ajax({
        type: "GET",
        url: "http://localhost:3000/get_part_id",
        dataType: "json"
      }).done (function (data) {
        console.log("Creating plus delays...")
        Math.seedrandom((data.id).toString());
        //Math.seedrandom('hello.');
        //plus_delays = 
        plus_delays = getRandsThatSumTo(data.num_stim, data.num_stim * 5000) // average of 5s per fixation
        console.log("printing plus_delays...")
        console.log(plus_delays);

      });

    };

    $.fn.setCursorPosition = function(pos) {
        if ($(this).get(0).setSelectionRange) {
            $(this).get(0).setSelectionRange(pos, pos);
        } else if ($(this).get(0).createTextRange) {
            var range = $(this).get(0).createTextRange();
            range.collapse(true);
            range.moveEnd('character', pos);
            range.moveStart('character', pos);
            range.select();
        }
    }



    // record all keystrokes + time
    $(document).ready(function() { 
      $(document).keydown(function(event) {
        console.log("detecting keystroke")
        if (!has_started) {
          console.log("has not started")
          // event.keyCode = "=" -- 61 on Firefox, 187 otherwise
          if (event.keyCode == 187) {
            console.log("equals sign detected")
            var the_url ="http://localhost:3000/start";
            $.ajax(
              { url: the_url, complete: function() {} }
            );
            has_started = true;
            stopped = false;
            startTimer();
          }
        } else if (!stopped) {
          if (record_keystrokes) {
            console.log("recording keystroke")
            var my_url ="http://localhost:3000/keystroke?key="+event.which;
            $.ajax(
              { url: my_url, complete: function() {} }
            );
          }
        } 
      });
      // prepare fixation focal relax
      $("#plus_img").width($(window).width());
      $("#plus_img").height($(window).height());
      $("#plus_img").show();

      $('#codesnippet_editable').focus();
      $("#textarea_div").height($(window).height() - 100);
      $("#codesnippet_editable").css("height", "100%");
    });



    const Categories = Object.freeze({
      ProseWritingA: 0,
      ProseWritingB: 1,
      CodeWritingX: 2,
      CodeWritingY:  3
    });

    var stimulus_time = 30000
    var counter = 0;
    var remember_category = 0;

    function displayNextStimuli() {
      console.log("Displaying next stimuli...")

      // Get Code Mirror Object
      var editor = $('.CodeMirror')[0].CodeMirror;
      var cm = editor.getWrapperElement();
        
      // Hide Code Mirror object and make sure not recording keystrokes
      $(cm).readOnly = true;
      $(cm).hide();
      record_keystrokes = false;

      // Record previous answer (regardless of if we should stop!)
      var text = editor.getValue();
      var prompt = document.getElementById('question').innerHTML;
      if (prompt != "Loading..." && counter != 0) {
        var query = "http://localhost:3000/write_answer?area=" + encodeURIComponent(text) + "&prompt=" + encodeURIComponent(prompt) + "&index=" + curr_index + "&prev_delay=" + plusDelay + "&stimulus_time=" + stimulus_time;
        $.ajax({
          type: "GET",
          url: query,
          dataType: "json"
        });
      }

      // Make GET request for new stimuli
      var next_stim_query = "http://localhost:3000/nextstim"
      $.ajax({
        type: "GET",
        url: next_stim_query,
        dataType: "json"
      }).done (function (data) {

        if (data.stop) {
          // Server will check bounds... if finished category, keep fixation shown...
          // ... and don't make next call to DisplayNextStimuli
          console.log("Server says we should stop")
          console.log("You have completed this section")
          $("#plus_img").show();
          $("#plus_img").hide();
          $("#question").hide();
          var para = document.createElement("p");
          var node = document.createTextNode("You have completed section: " + remember_category);
          para.appendChild(node);

          var element = document.getElementById("over");
          element.appendChild(para);
          stopped = true;
          counter = 0;
        } else {  // If we should not stop

          //console.log(plus_delays)
          plusDelay = plus_delays[counter]
          if (data.number_stim == 0) {
            plusDelay += 10000 // add 10s to first plus delay of category
          }
          console.log("Plus delay is", plusDelay)

          stimulus_time = data.time;
          console.log(stimulus_time)
          

          var stim_marker_url ="http://localhost:3000/keystroke_stim_marker";
          $.ajax(
            { url: stim_marker_url, complete: function() {} }
          );

          $("#plus_img").show().delay(plusDelay).queue(
            function(n) {
                $(this).hide(); 
                $(cm).readOnly = false;
                $(cm).show();
                editor.refresh();
                console.log("Setting to true")
                record_keystrokes = true;
                counter += 1;
                n();
            }
          );

          // Per above, queue next call to DNS
          $(document).delay(stimulus_time + plusDelay).queue(
            function(n) {
              displayNextStimuli();
              n();
            }
          );
          
          // FIXME - could refactor to below:
          // stimulu s= stimuli[data.category]
          // and then set CM mode based on category
          var stimulus;
          curr_index = data.index;
          remember_category = data.category;
          if (data.category == Categories.ProseWritingA) {
            stimulus = stimuli[0][data.index];
            console.log("category a");
            editor.setOption("mode", "text/plain");
          } else if (data.category == Categories.ProseWritingB) {
            stimulus = stimuli[1][data.index];
            console.log("category b");
            editor.setOption("mode", "text/plain");
          } else if (data.category == Categories.CodeWritingX) {
            stimulus = stimuli[2][data.index];
            console.log("category c");
            editor.setOption("mode", "text/x-c++src");
          } else {
            stimulus = stimuli[3][data.index];
            console.log("category d");
            editor.setOption("mode", "text/x-c++src");
          }
          console.log(stimulus);
          document.getElementById("question").innerHTML = stimulus.prompt;
          editor.setValue(stimulus.text);
          
          editor.focus()
          editor.setCursor({line: stimulus.line, ch: stimulus.character})

          editor.refresh();
          editor.focus()
        }
      }
      );        
    }

    function startTimer() {
      console.log("Starting timer...")
      var editor = $('.CodeMirror')[0].CodeMirror;
      editor.focus()
      displayNextStimuli()
    }

  </script>
</head>
<body>
  <p id="question">Loading...</p>
  <link rel="stylesheet" href="codemirror/lib/codemirror.css">
  <script src="codemirror/lib/codemirror.js"></script>
  <script src="codemirror/addon/edit/matchbrackets.js"></script>
  <script src="codemirror/addon/edit/closebrackets.js"></script>
  <script src="codemirror/addon/edit/continuecomment.js"></script>
  <script src="codemirror/mode/javascript/javascript.js"></script>
  <script src="codemirror/mode/clike/clike.js"></script>

  <div>
    <textarea rows="4" cols="50" name="codesnippet_editable" id="codesnippet_editable" autofocus>Please wait</textarea>
    <div id="rest_div" style="display: none;" align="center">
      <p style="color:red;font-size:256px;">+</p>
    </div>

  </div>
  <div id="plus_img" style="position:absolute;top:50%;height:100%;left:50%;z-index:1000;font-size:500px;color:red;text-align:center;width:100%;margin:auto;
  background-color:white;vertical-align:middle;transform: translate(-50%, -50%);">+</div>
  <div id="over"></div>

</body>
</html>
